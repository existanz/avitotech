# **Тестовое задание Avito - Магазин мерча**

## Установка и запуск

1. Клонировать этот репозиторий:
```bash
git clone https://github.com/existanz/avitotech
```

2. Установить зависимости:
```bash
go mod download
```

3. Перед запуском заполнить файл `.env` в корне проекта. Воспользуйтесь файлом `.env.example` для примера.


4. Для удобства запуска приложения используется Makefile.  
    
    4.1 Запустить приложение в докере:

    ```bash
    make docker-run
    ```  

    4.2 Запустить приложение локально:

    ```bash
    make run
    ```
    4.3 Запустить контейнер с базой данных:
    ```bash
    make docker-db
    ```
 
5. При первом запуске необходимо выполнить миграции.
Для миграции используется пакет `goose`. 
Если вы используете другой мигратор, файлы для миграции находятся в папке `/migrations`  

    5.1 Установка goose:
    ```bash
    go install github.com/pressly/goose/v3/cmd/goose@latest
    ```
    5.2 Выполнение миграций:
    ```bash
    make migrate-up
    ```


6. Доступ к API по адресу http://localhost:8080

## API

### 1. Аутентификация и получение JWT-токена. При первой аутентификации пользователь создается автоматически.
**POST /api/auth**  
req:
```json
{
  "username": "string",
  "password": "string"
}
```
resp:
```json
{
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE3NDAzMzM3NDMsInVzZXJfaWQiOjAsInVzZXJuYW1lIjoi0J_RgNC40LrQvtC70YzQvdC-In0.-eHy-QfVaKFpbBwBid2YxaFSNC0on1ECTbYd5h7sm_A"
}
```

### 2. Получить информацию о монетах, инвентаре и истории транзакций.
**GET /api/info**
```
Authorization: Bearer <token>
```
resp:
```json
{
    "coins": 0,
    "inventory": [
        {
            "type": "string",
            "quantity": 0
        }
    ],
    "coinHistory": {
        "received": [
          {
            "fromUser": "string",
            "amount": 0
          }
        ],
        "sent": [
            {
                "toUser": "string",
                "amount": 0
            }
        ]
    }
}
```
### 3. Отправить монеты другому пользователю.
**POST /api/sendCoin**
```
Authorization: Bearer <token>
```
req:
```json
{
  "toUser": "string",
  "amount": 0
}
```
### 4. Купить предмет за монеты
**GET /api/buy/{item}**
```
Authorization: Bearer <token>
```

## Стек:
*PostgreSQL*, *docker*, *gin*, *JWT*, *goose*, *log/slog*,   
Кэш: *in memory*,   
Линтер: *golangci-lint*

## Вопросы:
- Нужно ли хранить в транзакциях данные о покупках
и первичном начислении?
  - В требованиях этого нет, и структура транзакций не предполагает использования типа транзакций 
  для покупок и начислений. Но это будет полезно реализовать для аналитики и отслеживания.
  К примеру можно будет всегда проверить консистентность данных конкретных пользователей.
  - Не смотря на то, что это противоречит принципу YAGNI я при проектировании базы данных 
  добавил колонку для типа транзакций, чтобы в будущем было легче добавить данную функциональность.

- Нужно ли связывать item в инвентаре с магазином?
  - Вопрос неоднозначный. С одной стороны предметы в инвентаре могут исчезнуть в магазине. Поскольку
  количество мы не храним, недоступные в магазине предметы необходимо будет удалять из него. При этом
  связь с инвентарём будет мешать это сделать.
  - С другой стороны, если предметы в инвентаре не связаны с магазином, то это гипотетически позволит
  добавлять в инвентарь недоступные для приобретения предметы (например какой-нибудь майбах). Данный
  сервис, конечно не даст возможности таких действий, но на уровне базы данных никто не запрещает такое
  поведение.

- Что можно и нельзя хранить в кэше?  
    - Кэшировть критичные данные не стоит. У нас это например данные о монетах и транзакциях. Чтож остаётся
    только инвентарь и это немного ускорит обработку запросов.